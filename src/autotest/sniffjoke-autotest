#!/bin/bash 

# if you want modify the test, simply create those file by hands

red='\e[0;31m'
black='\e[0;30m'
blue='\e[1;34m'
green='\e[1;32m'
yellow='\e[1;33m'
white='\e[1;37m'

#default values
LOCATION=
WORKPATH=
TESTN=1

usage()
{
cat << EOF
usage: $0 options

This script runs plugins test along different destinations OS
to determinate the selection of plugins that correctly works
in the current location.

every plugin it's tested with one of each scrambling tech.

OPTIONS:
   -h      show this message
   -l      location name                                    (required)
   -d      path of 'generic/' location, acting as default   (required)
   -n      number of tests to be passed for the single hack (default 1)
EOF
}

dump_plugin_file() {
cat >> $PLUGINLIST << __EOF__
fake_close_fin,PRESCRIPTION
fake_close_fin,MALFORMED
fake_close_fin,GUILTY
fake_close_rst,PRESCRIPTION
fake_close_rst,MALFORMED
fake_close_rst,GUILTY
fake_data,PRESCRIPTION
fake_data,MALFORMED
fake_data,GUILTY
fake_seq,PRESCRIPTION
fake_seq,MALFORMED
fake_seq,GUILTY
fake_syn,PRESCRIPTION
fake_syn,MALFORMED
fake_syn,GUILTY
fake_window,PRESCRIPTION
fake_window,MALFORMED
fake_window,GUILTY
fragmentation,INNOCENT
segmentation,INNOCENT
shift_ack,PRESCRIPTION
shift_ack,MALFORMED
shift_ack,GUILTY
valid_rst_fake_seq,INNOCENT
__EOF__
}

start_test() {
    PNAME=`echo $PLUGIN | sed -es/\\,.*//`
    SCRAMBLE=`echo $PLUGIN | sed -es/.*\,//`
    TESTID=`echo $PLUGIN | tr "," "-"`
    workingdir="/tmp/$LOCATION/$TESTID"
    echo -e "\n$green* COMBINATION OF TESTS ($yellow$PLUGNDX/$PLUGIN_NUMBER$green)$blue"
    echo -e "Plugin Name\t$yellow\t[$PNAME]$blue\nScramble\t$yellow\t[$SCRAMBLE]$blue\nTestID\t\t$yellow\t[$TESTID]$blue\nTest directory\t$yellow\t[$workingdir]"
    mkdir -p $workingdir
    echo $SERVER_IP > "$workingdir/ipwhitelist.conf"
    echo -e "$red* Executing sniffjoke with $PLUGIN combo, using these options:$yellow"
    echo -e "sniffjoke --debug 6 --start --dir /tmp/$LOCATION --location $TESTID --only-plugin $PLUGIN --whitelist $white"
    $SNIFFJOKEBIN --debug 6 --start --dir /tmp/$LOCATION --location $TESTID --only-plugin $PLUGIN --whitelist &>$workingdir/binout.log
    sleep 2
    $SNIFFJOKECLIBIN stat > $workingdir/dumped_stat.log
    cd $workingdir
    # $SERVER is like http://www.delirandom.net/sniffjoke_autotest/post_echo.php
    INTERFACE=`$SNIFFJOKECLIBIN stat | grep "hijacked interface" | cut -b 21-`
    echo "starting tcpdump in $INTERFACE dumping $workingdir/$PNAME-$SCRAMBLE.pcap tcp port 80 and host $SERVER_IP or icmp"
    (tcpdump -i $INTERFACE -w $workingdir/$PNAME-$SCRAMBLE.pcap -s 0 tcp port 80 and host $SERVER_IP or icmp) &
    ps axf > $workingdir/ps-axf.log
    route -n > $workingdir/route-n.log
    sleep 1
    for i in `seq 1 $TESTN`;
    do
        echo "starting curl to post/echo at $SERVER_ADDR ($SERVER_IP) under monitoring. test number #$i"
        nohup curl --limit-rate 15k --retry 0 --max-time 10 -o "$PNAME-$SCRAMBLE-$i.received" \
            -d "sparedata=`cat $GENERATEDFILE`" $SERVER > "$PNAME-$SCRAMBLE-$i.curl_output"
        sleep 1
    done
    $SNIFFJOKECLIBIN quit > $workingdir/dumped_quit.log
    sleep 1
    killall -TERM tcpdump
    for i in `seq 1 $TESTN`;
    do
        if ! [ -e "$PNAME-$SCRAMBLE-$i.received" ]; then
            CHECKSUM="{unexistent-output-file}"
        else
            CHECKSUM=`md5sum "$PNAME-$SCRAMBLE-$i.received" | cut -b -32`
        fi

        echo "orig:$VERIFYSUM recv:$CHECKSUM $TESTID $i" >> /tmp/$LOCATION/SjcollectedFeedback
        if [ $VERIFYSUM != $CHECKSUM ];
        then
            # the .failed_hacks and the .working_hacks is generated and treated in the same style
            echo "$SCRAMBLE" >> "/tmp/$LOCATION/$PNAME.failed_hacks"
            # the follow are useful infos for debug
            echo "$VERIFYSUM vs $CHECKSUM from $PNAME-$SCRAMBLE-$i" >> "/tmp/$LOCATION/$PNAME.failed_info"
            cat "$PNAME-$SCRAMBLE-$i.curl_output" >> "/tmp/$LOCATION/$PNAME.failed_info"
	    break
        else
            echo $i >> "$PNAME-$SCRAMBLE.passed_count"
        fi
        if [ $i -eq $TESTN ];
        then
            echo "$SCRAMBLE" >> "/tmp/$LOCATION/$PNAME.working_hacks"
        fi
    done
    cd ..
    echo "finished test in $TESTID"
}

while getopts “hl:d:n:” OPTION
do
     case $OPTION in
         h)
             usage
             exit 1
             ;;
         l)
             LOCATION=$OPTARG
             ;;
         d)
             WORKPATH=$OPTARG
             ;;
         n)
             TESTN=$OPTARG
             ;;
         ?)
             usage
             exit
             ;;
     esac
done

USERID=`id -u`
if [ $USERID != "0" ]; then
    echo "- Error, only root should run $0"
    exit;
fi

if [ -z $LOCATION ]; then
    usage
    echo -en "\n"
    echo "it's required a LOCATION name, eg: office, home, nickhome, starbucks..."
    echo "sniffjoke-autotest will generate the best plugins_enabled.conf usable in this environment"
    echo "at the end of the tests (that include continuos restarting of sniffjoke with different options)"
    echo "will be created a new directory describing your location. after you will customize the options"
    exit;
fi

if [ -z $WORKPATH ]; then
    usage
    echo -en "\n"
    echo "it's required the PATH of commonly used working dir, where 'generic' is installed"
    echo "usually it's /usr/local/var/sniffjoke, otherwise, try to locate where generic location has"
    echo "been installed in your distro"
    exit;
fi

if [ ! -d $WORKPATH ]; then
    usage
    echo -en "\n"
    echo "option \"-d\" wrong argument: no such directory exist"
    exit;
fi

if [ ! -d "$WORKPATH/generic" ]; then
    usage
    echo -en "\n"
    echo "options \"-d\" invalid directory: we are looking for the path containing 'generic/'"
    echo "sniffjoke-autotest create at the given \"-d\", the new '$LOCATION/' copying some files from 'generic/'"
    exit;
fi

if [ -d "/tmp/$LOCATION" ]; then
    echo "- remove your /tmp/$LOCATION directory: already present"
    # call me old, but I don't put a blind rm -rf on a script run by root :P
    exit
fi

SNIFFJOKEBIN=`which sniffjoke`
if [ -z $SNIFFJOKEBIN ]; then
    echo "\"which sniffjoke\" has found nothing"
    echo "Are sniffjoke installed with the name \"sniffjoke\" ?"
    exit;
fi

SNIFFJOKECLIBIN=`which sniffjokectl`
if [ -z $SNIFFJOKECLIBIN ]; then
        echo "\"which sniffjokectl\" has found nothing"
        echo "Are sniffjoke installed with the name \"sniffjokectl\" ?"
        exit;
fi

echo "+ Starting SniffJoke hacks test"
echo "* Stopping running sniffjoke ($SNIFFJOKECLIBIN quit)"
$SNIFFJOKECLIBIN quit

PPATH="/usr/local/lib/sniffjoke"
echo "* using plugin path $PPATH"

FILEURL="http://www.delirandom.net/sniffjoke/testsuite.info"
echo "retrivering multi-OS testing server list ($FILEURL)"
SERVERFILE="/tmp/testsuite.info"
wget -O $SERVERFILE $FILEURL

if ! [ -e $SERVERFILE ]; then
    echo "- unable to retriver $SERVERFILE with [$FILEURL]"
    exit;
fi

PLUGINLIST="/tmp/$LOCATION/sniffjoke-testsuite-plugins"
if ! [ -e $PLUGINLIST ]; then
    mkdir /tmp/$LOCATION
    dump_plugin_file
fi
PLUGIN_NUMBER=`wc -l < $PLUGINLIST`

# generate the SPAREDATA file to send
GENERATEDFILE="/tmp/$LOCATION/SPAREDATA.generated"
# the number '6' is not used in the test because sniffjoke, when runned
# in debug mode (--debug 6) instead of filling the random segment of data
# inject with random data, use the number '6'. Is useful when debugging 
# an hack.
seq 1000 9000 | tr -d [:cntrl:] | sed -e's/6/111/g' | strings > $GENERATEDFILE
VERIFYSUM=`md5sum $GENERATEDFILE | cut -b -32`

for PLUGNDX in `seq 1 $PLUGIN_NUMBER`; do
    PLUGIN=`head -$PLUGNDX $PLUGINLIST | tail -1`

#    OS="WINDOWS"
#    SERVER=`cat "$SERVERFILE" | grep "$OS" | cut -b 9-`
#    echo $SERVER
#    start_test

    # those test need to be fixed or be used only where my test script will be hosted
    OS="LINUX"
    SERVER=`grep "$OS=" $SERVERFILE | cut -b 7-`
    SERVER_ADDR=`echo $SERVER | cut -b 8- | sed -e's/\/.*//'`
    SERVER_IP=`host $SERVER_ADDR | head -1 | sed -e's/.*address\ //'`
    start_test

#    OS="OTHER"
#    SERVER=`grep "$OS=" $SERVERFILE | cut -b 7-`
#    echo $SERVER
#    start_test
done

# parse analysis output to build a plugins_enabler.conf

success=`ls /tmp/$LOCATION/*.working_hacks`
PeL="/tmp/$LOCATION/plugins-enabled.conf"
echo -en "\n# this is an autogenerated file by sniffjoke-autotest " > $PeL 
echo -en "\n# wheneven your network router, provider or some malfunction is detected" >> $PeL
echo -en "\n# you are invited to regenerate this file" >> $PeL
echo -en "\n# this plugins_enabled.conf are dumped for location: $LOCATION" >> $PeL
echo -en "\n\n" >> $PeL

success_count=0
for hack in $success; do
    hackName=`basename $hack | sed -es/.working_hacks//`
    scramble=`cat $hack | tr " " "," | tr [:cntrl:] ","`
    echo -en "\n$hackName,$scramble" | sed -es/,\$// >> $PeL
    success_count=$(($success_count+1));
done

echo -en "\n\n# follow the hacks+scramble that don't pass the sniffjoke-autotest in environment $LOCATION\n" >> $PeL
failure_count=0
failure=`ls /tmp/$LOCATION/*.failed_hacks`
for hack in $failure ; do
    hackName=`basename $hack | sed -es/.failed_hacks//`
    scramble=`cat $hack | tr " " "," | tr [:cntrl:] ","`
    echo -en "\n# $hackName,$scramble" | sed -es/,\$// >> $PeL
    failure_count=$(($failure_count+1));
done

now=`date`
echo -en "\n\n# Generated in date: $now\n" >> $PeL

echo "file /tmp/$LOCATION/plugins_enabled.conf has been generated"
chmod 444 /tmp/$LOCATION/plugins-enabled.conf
mkdir $WORKPATH/$LOCATION
cp $WORKPATH/generic/port-aggressivity.conf $WORKPATH/$LOCATION
cp $WORKPATH/generic/sniffjoke-service.conf $WORKPATH/$LOCATION
cp /tmp/$LOCATION/plugins-enabled.conf $WORKPATH/$LOCATION/plugins-enabled.conf

echo -e "$yellow \n\nFINISHED!\n"
echo -e " $red $failure_count combinations of hack+scramble have not worked"
echo -e " $green $success_count combinations of hack+scramble have worked correctly"

echo -e "$blue\ncopyed in $WORKPATH/$LOCATION with the other default configuration file. You now could customize your location"
echo "now you will start sniffjoke with the option --location $LOCATION when you are in this network environment."

# clearing gay colors
tput sgr0

echo "SniffJoke is in BETATESTING: if you want contribute, type your nick or a simple string: the test output will be compressed for be sent to sniffjoke-team@delirandom.net."
echo "Otherwise, for don't generate the tar.gz, leave the string empty:"
echo -n "testerID: "
read testerID

if [ -z $testerID ]; then
    echo "empty string: test finished"
else
    pushd /tmp
    dFname="Sj-test-$testerID-$LOCATION.tar.gz"
    tar zcf $dFname $LOCATION/
    echo "thanks, $dFname has been generated, you will sent it to sniffjoke-team@delirandom.net, no one of your data will be disclosed outside the developers and no other use beside analysis and statistics will be done"
fi
